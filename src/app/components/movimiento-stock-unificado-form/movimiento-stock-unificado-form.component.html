<!-- src/app/components/movimiento-stock-unificado-form/movimiento-stock-unificado-form.component.html -->
<div class="form-container" [class.loading]="isLoading">
  <h2>ğŸ¯ Nuevo Movimiento de Stock</h2>

  <div class="form-content">
    <form [formGroup]="form" (ngSubmit)="guardar()">
      <!-- Producto -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>ğŸ“¦ Producto *</mat-label>
        <mat-select formControlName="id_producto" [disabled]="isLoading">
          <mat-option *ngFor="let producto of productos" [value]="producto.id_producto">
            {{ producto.nombre }} - Stock: {{ producto.stock }}
          </mat-option>
        </mat-select>
        <mat-error *ngIf="form.get('id_producto')?.hasError('required')">
          Seleccione un producto
        </mat-error>
      </mat-form-field>

      <!-- Tipo de Movimiento -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>ğŸ”„ Tipo de Movimiento *</mat-label>
        <mat-select formControlName="tipo_movimiento">
          <mat-option *ngFor="let tipo of tiposMovimiento" [value]="tipo.value">
            {{ tipo.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Cantidad -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>ğŸ“Š Cantidad *</mat-label>
        <input matInput type="number" formControlName="cantidad" min="1" placeholder="Ingrese la cantidad">
        <mat-error *ngIf="form.get('cantidad')?.hasError('required')">
          La cantidad es requerida
        </mat-error>
        <mat-error *ngIf="form.get('cantidad')?.hasError('min')">
          La cantidad debe ser mayor a 0
        </mat-error>
      </mat-form-field>

      <!-- SecciÃ³n de GestiÃ³n de Lote -->
      <div class="lote-section" *ngIf="form.get('id_producto')?.value">
        <h4>ğŸ·ï¸ GestiÃ³n de Lote</h4>
        
        <!-- Selector de modo de gestiÃ³n -->
        <mat-radio-group formControlName="gestion_lote" class="radio-group" *ngIf="esIngreso">
          <mat-radio-button value="automatico" class="radio-option">
            <div class="radio-content">
              <span class="radio-title">ğŸ”„ AutomÃ¡tico</span>
              <span class="radio-description">Generar lote automÃ¡ticamente</span>
            </div>
          </mat-radio-button>
          
          <mat-radio-button value="manual" class="radio-option">
            <div class="radio-content">
              <span class="radio-title">âœï¸ Manual</span>
              <span class="radio-description">Ingresar datos del lote manualmente</span>
            </div>
          </mat-radio-button>
          
          <mat-radio-button value="existente" class="radio-option">
            <div class="radio-content">
              <span class="radio-title">ğŸ“‹ Existente</span>
              <span class="radio-description">Usar lote existente</span>
            </div>
          </mat-radio-button>
        </mat-radio-group>

        <!-- Lote AutomÃ¡tico -->
        <div *ngIf="esIngreso && modoLoteActual === 'automatico'" class="lote-subsection automatico">
          <div class="auto-lote-info">
            <div class="info-item">
              <strong>NÃºmero de Lote:</strong> 
              <span class="lote-number">{{ generarNumeroLote() }}</span>
            </div>
            <div class="info-item">
              <strong>Fecha de Caducidad:</strong> 
              <span class="fecha-caducidad">
                {{ form.get('fecha_caducidad_auto')?.value | date:'dd/MM/yyyy' }}
              </span>
            </div>
          </div>
          <div class="info-note">
            âœ… Este lote se generarÃ¡ automÃ¡ticamente al guardar
          </div>
        </div>

        <!-- Lote Manual -->
        <div *ngIf="esIngreso && modoLoteActual === 'manual'" class="lote-subsection manual">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>NÃºmero de Lote *</mat-label>
            <input matInput formControlName="numero_lote_manual" placeholder="Ej: LOTE-001-2024">
            <mat-error *ngIf="form.get('numero_lote_manual')?.hasError('required')">
              El nÃºmero de lote es requerido
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Fecha de Caducidad *</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="fecha_caducidad_manual">
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-error *ngIf="form.get('fecha_caducidad_manual')?.hasError('required')">
              La fecha de caducidad es requerida
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Lote Existente (para ingresos) -->
        <div *ngIf="esIngreso && modoLoteActual === 'existente'" class="lote-subsection existente">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Seleccionar Lote Existente *</mat-label>
            <mat-select formControlName="id_lote_existente">
              <mat-option *ngFor="let lote of lotes" [value]="lote.id_lote">
                {{ lote.numero_lote }} | Stock: {{ lote.cantidad_actual }} | Caduca: {{ lote.fecha_caducidad | date:'dd/MM/yyyy' }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="form.get('id_lote_existente')?.hasError('required')">
              Seleccione un lote existente
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Lote para Egresos/Ajustes/Devoluciones -->
        <div *ngIf="!esIngreso" class="lote-subsection no-ingreso">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Seleccionar Lote *</mat-label>
            <input type="text" matInput formControlName="lote_search" [matAutocomplete]="auto" placeholder="Buscar lote...">
            <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onLoteSelected($event)">
              <mat-option *ngFor="let lote of filteredLotes | async" [value]="lote">
                <div class="lote-option">
                  <strong>{{ lote.numero_lote }}</strong>
                  <div class="lote-details">
                    <span>Stock: {{ lote.cantidad_actual }}</span>
                    <span>Caduca: {{ lote.fecha_caducidad | date:'dd/MM/yyyy' }}</span>
                  </div>
                </div>
              </mat-option>
            </mat-autocomplete>
            <mat-error *ngIf="form.get('id_lote_existente')?.hasError('required')">
              Seleccione un lote
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- DescripciÃ³n -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>ğŸ“ DescripciÃ³n</mat-label>
        <textarea matInput formControlName="descripcion" rows="3" 
                  placeholder="DescripciÃ³n opcional del movimiento..."></textarea>
      </mat-form-field>
    </form>
  </div>

  <!-- Botones de acciÃ³n -->
  <div class="actions">
    <button mat-raised-button color="primary" 
            (click)="guardar()" 
            [disabled]="isSubmitting || form.invalid"
            class="btn-guardar">
      <mat-icon *ngIf="!isSubmitting">save</mat-icon>
      <mat-spinner *ngIf="isSubmitting" diameter="20"></mat-spinner>
      {{ isSubmitting ? 'Guardando...' : 'Guardar Movimiento' }}
    </button>
    
    <button mat-button type="button" (click)="cancelar()" [disabled]="isSubmitting">
      Cancelar
    </button>
  </div>

  <!-- Overlay de carga -->
  <div class="overlay" *ngIf="isLoading">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Cargando datos...</p>
  </div>
</div>