<h2 mat-dialog-title class="dialog-title">
  <mat-icon class="title-icon">{{ isEditMode ? 'edit' : 'person_add' }}</mat-icon>
  {{ isEditMode ? 'Editar' : 'Agregar' }} Cliente
</h2>

<mat-dialog-content>
  <div class="loading-overlay" *ngIf="isLoading">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <form [formGroup]="clienteForm" class="cliente-form">
    <!-- Información del Documento -->
    <div class="form-section">
      <h3 class="section-title">Información del Documento</h3>
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Tipo de Documento</mat-label>
          <mat-select formControlName="tipo_documento" (selectionChange)="onTipoDocumentoChange()" required>
            <mat-option *ngFor="let tipo of tiposDocumento" [value]="tipo.value">
              {{ tipo.label }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="clienteForm.get('tipo_documento')?.hasError('required')">
            El tipo de documento es requerido
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Número de Documento</mat-label>
          <input matInput formControlName="dni" required [maxLength]="clienteForm.get('tipo_documento')?.value === 'DNI' ? 8 : 11" />
          <mat-hint>
            <span *ngIf="clienteForm.get('tipo_documento')?.value === 'DNI'">8 dígitos</span>
            <span *ngIf="clienteForm.get('tipo_documento')?.value === 'RUC'">11 dígitos</span>
            <span *ngIf="clienteForm.get('tipo_documento')?.value === 'CE'">9-12 caracteres</span>
          </mat-hint>
          <mat-error>{{ getDocumentoError() }}</mat-error>
        </mat-form-field>
      </div>
    </div>

    <!-- Información Personal -->
    <div class="form-section">
      <h3 class="section-title">Información Personal</h3>
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field-full">
          <mat-label>Nombre Completo</mat-label>
          <input matInput formControlName="nombre" required />
          <mat-error *ngIf="clienteForm.get('nombre')?.hasError('required')">
            El nombre es requerido
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Teléfono</mat-label>
          <input matInput formControlName="telefono" required />
          <mat-error>{{ getTelefonoError() }}</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="form-field">
          <mat-label>Tipo de Cliente</mat-label>
          <mat-select formControlName="tipo_cliente" required>
            <mat-option *ngFor="let tipo of tiposCliente" [value]="tipo.value">
              {{ tipo.label }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="clienteForm.get('tipo_cliente')?.hasError('required')">
            El tipo de cliente es requerido
          </mat-error>
        </mat-form-field>
      </div>

     <!-- En la sección de Información Personal -->
<div class="form-row">
  <mat-form-field appearance="outline" class="form-field-full">
    <mat-label>Razón Social (Para facturación)</mat-label>
    <input 
      matInput 
      formControlName="razon_social" 
      placeholder="Ingrese la razón social para facturación"
    />
    <mat-hint>Opcional para facturación</mat-hint>
  </mat-form-field>
</div>
    </div>

    <!-- Dirección -->
    <div class="form-section">
      <h3 class="section-title">Dirección</h3>
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field-full">
          <mat-label>Dirección Completa</mat-label>
          <textarea matInput formControlName="direccion" required rows="2"></textarea>
          <mat-error *ngIf="clienteForm.get('direccion')?.hasError('required')">
            La dirección es requerida
          </mat-error>
        </mat-form-field>
      </div>
    </div>

    <!-- Coordenadas con botón de geocodificación -->
    <div class="form-section">
      <h3 class="section-title">Geolocalización</h3>
      <div class="form-row">
        <mat-form-field appearance="outline" class="form-field-full">
          <mat-label>Coordenadas</mat-label>
          <input
            matInput
            formControlName="coordenadas"
            placeholder="Ej: -8.3791,-74.5539"
            readonly
          />
          <mat-hint>Se mostrarán al calcular la ubicación</mat-hint>
        </mat-form-field>
      </div>

      <div class="form-row">
        <button
          type="button"
          mat-raised-button
          color="accent"
          (click)="manualGeocode()"
          [disabled]="!canGeocode() || isGeocoding"
          class="geocode-btn"
        >
          <mat-icon>location_on</mat-icon>
          {{ isGeocoding ? 'Calculando...' : 'Calcular Coordenadas' }}
        </button>

        <div class="geocode-status" *ngIf="isGeocoding">
          <mat-spinner diameter="20"></mat-spinner>
          <span>Buscando ubicación...</span>
        </div>
      </div>
    </div>
  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()" class="cancel-button">Cancelar</button>
  <button
    mat-raised-button
    color="primary"
    (click)="onSubmit()"
    [disabled]="clienteForm.invalid || isLoading"
    class="submit-button"
  >
    <mat-icon *ngIf="isLoading" class="spinner-icon">
      <mat-spinner diameter="16"></mat-spinner>
    </mat-icon>
    {{ isEditMode ? 'Actualizar' : 'Guardar' }}
  </button>
</mat-dialog-actions>