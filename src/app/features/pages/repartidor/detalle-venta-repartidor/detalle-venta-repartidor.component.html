<!-- src/app/features/pages/repartidor/detalle-venta-repartidor/detalle-venta-repartidor.component.html -->
<div class="repartidor-container">
  <!-- Header compacto -->
  <div class="header-compacto">
    <button class="btn btn-secondary" (click)="volverAtras()">
      <i class="fas fa-arrow-left"></i> Volver
    </button>
    <h1><i class="fas fa-file-invoice"></i> Detalle de Entrega #{{venta?.id_venta}}</h1>
  </div>

  <!-- Loading -->
  <div class="loading-section" *ngIf="loading">
    <div class="spinner"></div>
    <p>Cargando detalles de la entrega...</p>
  </div>

  <!-- Error -->
  <div class="error-section" *ngIf="error && !loading">
    <div class="alert alert-error">
      <i class="fas fa-exclamation-triangle"></i>
      {{ error }}
    </div>
    <button class="btn btn-primary" (click)="volverAtras()">
      <i class="fas fa-arrow-left"></i> Volver
    </button>
  </div>

  <!-- Detalles de la entrega - DISEÑO COMPACTO -->
  <div class="detalle-entrega-compacto" *ngIf="venta && !loading">

    <!-- Fila 1: Información del cliente y productos -->
    <div class="fila-principal">
      <!-- Información del Cliente -->
      <div class="seccion info-cliente-compacto">
        <h2><i class="fas fa-user"></i> Información del Cliente</h2>
        <div class="cliente-grid-compacto">
          <div class="info-item">
            <label>Nombre:</label>
            <span>{{ venta.nombre_completo }}</span>
          </div>
          <div class="info-item" *ngIf="venta.razon_social">
            <label>Razón Social:</label>
            <span>{{ venta.razon_social }}</span>
          </div>
          <div class="info-item">
            <label>Teléfono:</label>
            <span><i class="fas fa-phone"></i> {{ venta.telefono }}</span>
          </div>
          <div class="info-item full-width">
            <label>Dirección:</label>
            <span><i class="fas fa-map-marker-alt"></i> {{ venta.direccion }}</span>
          </div>
          <div class="info-item full-width" *ngIf="venta.notas">
            <label>Notas:</label>
            <span class="notas">{{ venta.notas }}</span>
          </div>
        </div>
      </div>

      <!-- Productos a Entregar -->
      <div class="seccion productos-compacto">
        <h2><i class="fas fa-boxes"></i> Productos a Entregar</h2>
        <div class="productos-lista">
          <div *ngFor="let detalle of venta.detalles" class="producto-item">
            <span class="producto-nombre">{{ detalle.producto_nombre || 'Producto' }}</span>
            <span class="producto-cantidad">{{ detalle.cantidad }}</span>
            <span class="producto-precio">S/ {{ detalle.precio_unitario }}</span>
            <span class="producto-subtotal">S/ {{ detalle.subtotal || (detalle.cantidad * detalle.precio_unitario) }}</span>
          </div>
        </div>
        <div class="total-productos">
          <strong>Total: S/ {{ venta.total }}</strong>
        </div>
      </div>
    </div>

    <!-- Fila 2: Información general y cronología -->
    <div class="fila-secundaria">
      <!-- Información General -->
      <div class="seccion info-general-compacto">
        <h2><i class="fas fa-info-circle"></i> Información General</h2>
        <div class="info-grid-denso">
          <div class="info-item-denso">
            <label>Estado:</label>
            <span class="badge" [ngClass]="getEstadoBadgeClass(venta.estado)">
              {{ venta.estado }}
            </span>
          </div>
          <div class="info-item-denso">
            <label>Total a Cobrar:</label>
            <span class="valor-destacado total-amount">S/ {{ venta.total }}</span>
          </div>
          <div class="info-item-denso">
            <label>Método de Pago:</label>
            <span>{{ venta.metodo_pago }}</span>
          </div>
          <div class="info-item-denso" *ngIf="isRutaIniciada()">
            <label>Tiempo Transcurrido:</label>
            <span class="tiempo-destacado">{{ calcularTiempoTranscurrido() }}</span>
          </div>
        </div>
      </div>

      <!-- Cronología Compacta -->
      <div class="seccion cronologia-compacta">
        <h2><i class="fas fa-clock"></i> Estado de Entrega</h2>
        <div class="timeline-denso">
          <div class="timeline-item-denso completed">
            <div class="timeline-marker-denso">
              <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="timeline-content-denso">
              <span class="timeline-title">Pedido Realizado</span>
              <span class="timeline-date">{{ formatearFechaCompleta(venta.fecha + 'T' + venta.hora) }}</span>
            </div>
          </div>

          <div class="timeline-item-denso" [ngClass]="{'completed': isRutaIniciada(), 'current': !isRutaFinalizada() && isRutaIniciada()}">
            <div class="timeline-marker-denso">
              <i class="fas fa-play-circle"></i>
            </div>
            <div class="timeline-content-denso">
              <span class="timeline-title">En Ruta</span>
              <span class="timeline-date" *ngIf="isRutaIniciada()">
                {{ formatearFechaHora(venta.fecha_inicio_ruta) }}
              </span>
              <span class="timeline-date" *ngIf="!isRutaIniciada()">
                Pendiente
              </span>
            </div>
          </div>

          <div class="timeline-item-denso" [ngClass]="{'completed': isRutaFinalizada(), 'current': isRutaFinalizada()}">
            <div class="timeline-marker-denso">
              <i class="fas fa-flag-checkered"></i>
            </div>
            <div class="timeline-content-denso">
              <span class="timeline-title">Entregado</span>
              <span class="timeline-date" *ngIf="isRutaFinalizada()">
                {{ formatearFechaHora(venta.fecha_fin_ruta) }}
              </span>
              <span class="timeline-date" *ngIf="!isRutaFinalizada()">
                En progreso
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Acciones del Repartidor -->
    <div class="seccion" *ngIf="venta.id_estado_venta === 5">
      <h2><i class="fas fa-tasks"></i> Gestión de Entrega</h2>
      
      <!-- Información del estado de la ruta -->
      <div class="ruta-info" *ngIf="isRutaIniciada(); else rutaNoIniciadaDetalle">
        <div class="alert alert-success">
          <i class="fas fa-check-circle"></i>
          <strong>Ruta en curso</strong>
          <p>La ruta fue iniciada el {{ formatearFechaHora(venta.fecha_inicio_ruta) }}</p>
          <p *ngIf="venta.ubicacion_inicio_ruta">
            <i class="fas fa-map-marker-alt"></i> Ubicación de inicio: {{ venta.ubicacion_inicio_ruta }}
          </p>
          <p><strong>Tiempo transcurrido:</strong> {{ calcularTiempoTranscurrido() }}</p>
        </div>
        
        <div class="info-note">
          <i class="fas fa-info-circle"></i>
          <span>Para gestionar esta entrega (marcar como pagado o cancelar), diríjase a <strong>Entregas Pendientes</strong>.</span>
        </div>
      </div>

      <ng-template #rutaNoIniciadaDetalle>
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i>
          <strong>Ruta no iniciada</strong>
          <p>Para gestionar esta entrega, primero debe iniciar la ruta desde <strong>Mis Rutas Asignadas</strong>.</p>
        </div>
      </ng-template>

      <!-- Botones de acción -->
      <div class="acciones-grid">
        <button class="btn btn-primary btn-lg" (click)="irAEntregasPendientes()">
          <i class="fas fa-list"></i> Ir a Entregas Pendientes
        </button>
        
        <button class="btn btn-info btn-lg" (click)="abrirMapa()">
          <i class="fas fa-map"></i> Ver en Mapa
        </button>
        
        <button class="btn btn-secondary btn-lg" (click)="volverAtras()">
          <i class="fas fa-arrow-left"></i> Volver Atrás
        </button>
      </div>
    </div>

    <!-- Información de entrega completada -->
    <div class="seccion" *ngIf="venta.id_estado_venta === 7">
      <div class="alert alert-success delivery-completed">
        <div class="delivery-header">
          <i class="fas fa-check-circle"></i>
          <h3>Entrega Completada</h3>
        </div>
        <p>Esta entrega fue marcada como pagada y completada.</p>
        <div class="delivery-details">
          <p><strong>Fecha de finalización:</strong> {{ formatearFechaHora(venta.fecha_fin_ruta) }}</p>
          <p><strong>Tiempo total de entrega:</strong> {{ calcularTiempoTotalEntrega() }}</p>
        </div>
      </div>
      <button class="btn btn-info" (click)="abrirMapa()">
        <i class="fas fa-map"></i> Ver Ubicación en Mapa
      </button>
    </div>

    <!-- Información de entrega cancelada -->
    <div class="seccion" *ngIf="venta.id_estado_venta === 8">
      <div class="alert alert-danger">
        <i class="fas fa-times-circle"></i>
        <strong>Entrega Cancelada</strong>
        <p *ngIf="venta.notas"><strong>Motivo:</strong> {{ venta.notas }}</p>
        <p *ngIf="venta.fecha_fin_ruta"><strong>Fecha de cancelación:</strong> {{ formatearFechaHora(venta.fecha_fin_ruta) }}</p>
      </div>
    </div>
  </div>
</div>