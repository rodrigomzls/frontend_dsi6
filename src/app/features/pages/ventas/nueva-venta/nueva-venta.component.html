<!-- src/app/features/pages/ventas/nueva-venta/nueva-venta.component.html -->
<div class="nueva-venta-container">
  <div class="header">
    <h1> Venta R√°pida</h1>
  </div>

  <div class="venta-content">
<!-- Secci√≥n Cliente -->
<div class="section cliente-section">
  <h2>Registar o Seleccionar Cliente üë§</h2>
  <div class="search-container">
    <div class="search-box">
      <input 
        type="text" 
        [(ngModel)]="searchCliente" 
        (input)="filtrarClientes()"
        (focus)="mostrarTodosClientes()"
        (blur)="onBlurCliente()"
        [placeholder]="venta.id_cliente === 0 ? 'Haz clic para ver todos los clientes...' : 'Cliente seleccionado'"
        class="search-input"
        #clienteInput>
      <button (click)="limpiarBusquedaCliente()" class="btn-clear">‚úï</button>
    </div>
    <button (click)="abrirModalClienteRapido()" class="btn-agregar-cliente">
      <span class="btn-icon">‚ûï</span>
      Nuevo Cliente
    </button>
  </div>

  <!-- Lista de clientes filtrados -->
  <div class="results-list" *ngIf="mostrarListaClientes && filteredClientes.length > 0">
    <div 
      *ngFor="let cliente of filteredClientes" 
      class="result-item"
      (mousedown)="seleccionarCliente(cliente)">
      <strong>{{ cliente.nombre_completo || cliente.persona?.nombre_completo }} - </strong>
      <span>{{ cliente.persona?.telefono }} - </span>
      <small>{{ cliente.tipo_cliente }}</small>
    </div>
  </div>

  <div *ngIf="mostrarListaClientes && filteredClientes.length === 0" class="no-results">
    No se encontraron clientes
  </div>

  <div *ngIf="venta.id_cliente !== 0" class="selected-cliente">
    ‚úÖ Cliente seleccionado: <strong>{{ clienteSeleccionadoNombre }}</strong>
    (ID: {{ venta.id_cliente }})
  </div>
</div>


<!-- Secci√≥n Productos -->
<div class="section productos-section">
  <h2>Seleccionar Productos üì¶</h2>
  
  <!-- B√∫squeda de productos -->
  <div class="search-box">
    <input 
      type="text" 
      [(ngModel)]="searchProducto" 
      (input)="filtrarProductos()"
      (focus)="mostrarTodosProductos()"
      (blur)="onBlurProducto()"
      [placeholder]="!productoSeleccionado ? 'Haz clic para ver todos los productos...' : 'Producto seleccionado'"
      class="search-input"
      #productoInput>
    <button (click)="limpiarBusquedaProducto()" class="btn-clear">‚úï</button>
  </div>

  <!-- Lista de productos filtrados -->
  <div class="results-list" *ngIf="mostrarListaProductos && filteredProductos.length > 0">
    <div 
      *ngFor="let producto of filteredProductos" 
      class="result-item"
      (mousedown)="seleccionarProducto(producto)">
      <strong>{{ producto.nombre }} - </strong>
      <span>S/ {{ producto.precio }} - </span>
      <small>Stock: {{ producto.stock }} | ID: {{ producto.id_producto || producto.id }}</small>
    </div>
  </div>

  <div *ngIf="mostrarListaProductos && filteredProductos.length === 0" class="no-results">
    No se encontraron productos
  </div>

  <!-- Agregar producto seleccionado -->
  <div *ngIf="productoSeleccionado" class="add-product-form">
    <div class="product-info">
      <strong>{{ productoSeleccionado.nombre }}</strong>
      <span>S/ {{ productoSeleccionado.precio }}</span>
      <small>Stock: {{ productoSeleccionado.stock }}</small>
    </div>
    <div class="quantity-controls">
      <label>Cantidad:</label>
      <input 
        type="number" 
        [(ngModel)]="cantidad" 
        min="1" 
        [max]="productoSeleccionado.stock"
        class="quantity-input">
      <button (click)="agregarProducto()" class="btn-add">Agregar</button>
      <button (click)="limpiarSeleccionProducto()" class="btn-cancel">Cancelar</button>
    </div>
  </div>
</div>
    <!-- Detalle de Venta -->
    <div class="section carrito-section">
      <h2>Detalle de Venta üõçÔ∏è</h2>
      
      <div *ngIf="venta.detalles.length === 0" class="empty-cart">
        <p>No hay productos en el carrito</p>
      </div>

      <div *ngIf="venta.detalles.length > 0" class="cart-items">
        <div *ngFor="let detalle of venta.detalles; let i = index" class="cart-item">
          <div class="item-info">
            <strong>{{ detalle.producto_nombre }}: </strong>
            <span>{{ detalle.cantidad }} x S/ {{ detalle.precio_unitario }}</span>
          </div>
          <div class="item-subtotal">
            S/ {{ detalle.cantidad * detalle.precio_unitario }}
            <button (click)="removerProducto(i)" class="btn-remove">üóëÔ∏è</button>
          </div>
        </div>
      </div>

      <div class="cart-total" *ngIf="venta.detalles.length > 0">
        <strong>Total: S/ {{ venta.total }}</strong>
      </div>
    </div>

    <!-- M√©todo de Pago-->
    <div class="section config-section">
      <h2>Pago üí≥</h2>
      
      <div class="form-group">
        <label>M√©todo de Pago:</label>
        <select [(ngModel)]="venta.id_metodo_pago" class="form-select">
          <option *ngFor="let metodo of metodosPago" [value]="metodo.id_metodo_pago">
            {{ metodo.metodo_pago }}
          </option>
        </select>
      </div>
    </div>

    <!-- Mensajes de Error -->
    <div *ngIf="error" class="error-message">
      {{ error }}
    </div>

    <!-- Botones de Acci√≥n -->
    <div class="action-buttons">
      <button 
        (click)="finalizarVenta()" 
        [disabled]="loading || venta.detalles.length === 0 || venta.id_cliente === 0"
        class="btn-primary">
        {{ loading ? 'Procesando...' : 'Finalizar Venta' }}
      </button>
    </div>
  </div>
</div>