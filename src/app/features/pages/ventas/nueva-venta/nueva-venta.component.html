<!-- Nueva versiÃ³n con 3 columnas -->
<div class="nueva-venta-container">
  <!-- Header mejorado -->
  <div class="header">
    <div class="header-content">
      <h1>Venta RÃ¡pida</h1>
      <p class="header-subtitle">Registro rÃ¡pido y eficiente de transacciones</p>
      <div class="header-stats">
        <span class="stat-item">ðŸ•’ {{ venta.hora }}</span>
        <span class="stat-item">ðŸ“… {{ venta.fecha }}</span>
        <span class="stat-item">ðŸ’¼ {{ getVendedorNombre() }}</span>
      </div>
    </div>
  </div>

  <!-- Contenido principal con 3 columnas -->
  <div class="venta-content">
    
    <!-- COLUMNA 1: Cliente y Carrito -->
    <div class="columna-izquierda">
      <!-- SecciÃ³n Cliente -->
      <div class="section cliente-section neumorphic-card">
        <div class="section-header">
          <h2>
            <i class="material-icons">person</i>
            Cliente
          </h2>
          <span class="section-badge" *ngIf="venta.id_cliente !== 0">âœ… Seleccionado</span>
        </div>
        
        <div class="search-container">
          <div class="search-box">
            <input 
              type="text" 
              [(ngModel)]="searchCliente" 
              (input)="filtrarClientes()"
              (focus)="mostrarTodosClientes()"
              (blur)="onBlurCliente()"
              [placeholder]="venta.id_cliente === 0 ? 'Buscar cliente por nombre, telÃ©fono o DNI...' : 'Cliente seleccionado'"
              class="search-input elegant-input"
              #clienteInput>
            <button (click)="limpiarBusquedaCliente()" class="btn-clear" title="Limpiar bÃºsqueda">
              <i class="material-icons">close</i>
            </button>
          </div>
          
          <button (click)="abrirModalClienteRapido()" class="btn-agregar-cliente btn-with-icon">
            <i class="material-icons">person_add</i>
            Nuevo Cliente
          </button>
        </div>

        <!-- Cliente seleccionado -->
        <div *ngIf="venta.id_cliente !== 0" class="selected-client-card">
          <div class="client-info">
            <i class="material-icons client-avatar">account_circle</i>
            <div class="client-details">
              <!-- Aplicar truncate aquÃ­ -->
      <h3>{{ clienteSeleccionadoNombre | truncate:30 }}</h3>
              <p>ID: {{ venta.id_cliente }}</p>
              <div class="client-tags">
                <span class="tag">Registrado</span>
                <span class="tag tag-success">VÃ¡lido</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Lista de resultados -->
        <div class="results-container" *ngIf="mostrarListaClientes">
          <div class="results-header">
            <span class="results-count">{{ filteredClientes.length }} clientes encontrados</span>
            <button (click)="mostrarListaClientes = false" class="btn-close-results">
              <i class="material-icons">expand_less</i>
            </button>
          </div>
          <div class="results-list">
            <div 
              *ngFor="let cliente of filteredClientes" 
              class="result-item hover-lift"
              (mousedown)="seleccionarCliente(cliente)">
              <div class="result-item-content">
                <i class="material-icons result-icon">person_outline</i>
                <div class="result-text">
                  <!-- Aplicar truncate aquÃ­ -->
        <strong>{{ (cliente.nombre_completo || cliente.persona?.nombre_completo) | truncate:25 }}</strong>
                  <div class="result-meta">
                    <span class="meta-item">
                      <i class="material-icons">phone</i>
                      {{ cliente.persona?.telefono || 'Sin telÃ©fono' | truncate:15 }}
                    </span>
                    <span class="meta-item">
                      <i class="material-icons">badge</i>
                     {{ cliente.tipo_cliente | truncate:15 }}
                    </span>
                  </div>
                </div>
                <i class="material-icons result-action">chevron_right</i>
              </div>
            </div>
          </div>
        </div>
      </div>
<!-- SecciÃ³n Productos -Debajo de Cliente -->
      <div class="section productos-section neumorphic-card">
        <div class="section-header">
          <h2>
            <i class="material-icons">inventory_2</i>
            Productos
          </h2>
          <span class="section-badge" *ngIf="venta.detalles.length > 0">
            ðŸ›’ {{ venta.detalles.length }} items
          </span>
        </div>

        <div class="search-box">
          <input 
            type="text" 
            [(ngModel)]="searchProducto" 
            (input)="filtrarProductos()"
            (focus)="mostrarTodosProductos()"
            (blur)="onBlurProducto()"
            [placeholder]="!productoSeleccionado ? 'Buscar producto por nombre, marca o cÃ³digo...' : 'Producto seleccionado'"
            class="search-input elegant-input"
            #productoInput>
          <button (click)="limpiarBusquedaProducto()" class="btn-clear" title="Limpiar bÃºsqueda">
            <i class="material-icons">close</i>
          </button>
        </div>

        <!-- Producto seleccionado para agregar -->
        <div *ngIf="productoSeleccionado" class="selected-product-card fade-in">
          <div class="product-card-header">
             <!-- Aplicar truncate aquÃ­ -->
           <h3>{{ productoSeleccionado.nombre | truncate:30 }}</h3>
            <span class="product-price">S/ {{ productoSeleccionado.precio | number:'1.2-2' }}</span>
          </div>
          
          <div class="product-card-body">
            <div class="product-stats">
              <div class="stat">
                <i class="material-icons">warehouse</i>
                <span>Stock: <strong>{{ productoSeleccionado.stock }}</strong></span>
              </div>
              <div class="stat">
                <i class="material-icons">category</i>
                <span>{{ productoSeleccionado.categoria?.nombre || 'Sin categorÃ­a' | truncate:15 }}</span>
              </div>
              <div class="stat">
                <i class="material-icons">local_offer</i>
                <span>{{ productoSeleccionado.marca?.nombre || 'Sin marca' | truncate:15 }}</span>
              </div>
            </div>
            
            <div class="add-product-controls">
              <div class="quantity-selector">
                <label>Cantidad:</label>
                <div class="quantity-buttons">
                  <button (click)="decrementarCantidad()" class="qty-btn">
                    <i class="material-icons">remove</i>
                  </button>
                  <input 
                    type="number" 
                    [(ngModel)]="cantidad" 
                    min="1" 
                    [max]="productoSeleccionado.stock"
                    class="quantity-input">
                  <button (click)="incrementarCantidad()" class="qty-btn">
                    <i class="material-icons">add</i>
                  </button>
                </div>
              </div>
              
              <div class="add-buttons">
                <button (click)="agregarProducto()" class="btn-add btn-with-icon">
                  <i class="material-icons">add_shopping_cart</i>
                  Agregar al Carrito
                </button>
                <button (click)="limpiarSeleccionProducto()" class="btn-cancel btn-with-icon">
                  <i class="material-icons">cancel</i>
                  Cancelar
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Lista de productos -->
        <div class="results-container" *ngIf="mostrarListaProductos">
          <div class="results-header">
            <span class="results-count">{{ filteredProductos.length }} productos encontrados</span>
            <button (click)="mostrarListaProductos = false" class="btn-close-results">
              <i class="material-icons">expand_less</i>
            </button>
          </div>
          <div class="results-list">
            <div 
              *ngFor="let producto of filteredProductos" 
              class="result-item hover-lift"
              (mousedown)="seleccionarProducto(producto)">
              <div class="result-item-content">
                <div class="product-image-placeholder">
                  <i class="material-icons">shopping_bag</i>
                </div>
                <div class="result-text">
                  <!-- Aplicar truncate aquÃ­ -->
        <strong>{{ producto.nombre | truncate:25 }}</strong>
                  <div class="result-meta">
                    <span class="meta-item">
                      <i class="material-icons">attach_money</i>
                      S/ {{ producto.precio | number:'1.2-2' }}
                    </span>
                    <span class="meta-item">
                      <i class="material-icons">layers</i>
                      Stock: {{ producto.stock }}
                    </span>
                    <span class="meta-item">
                      <i class="material-icons">category</i>
                       {{ producto.categoria?.nombre || 'General' | truncate:15 }}
                    </span>
                  </div>
                </div>
                <i class="material-icons result-action">add_circle_outline</i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- COLUMNA 2: Productos y MÃ©todos de Pago -->
    <div class="columna-centro">
      <!-- Carrito de Compras - -->
      <div class="section carrito-section neumorphic-card">
        <div class="section-header">
          <h2>
            <i class="material-icons">shopping_cart</i>
            Carrito de Compras
          </h2>
          <span class="section-badge section-badge-primary">
            Total: S/ {{ venta.total | number:'1.2-2' }}
          </span>
        </div>

        <div *ngIf="venta.detalles.length === 0" class="empty-cart-state">
          <div class="empty-cart-icon">
            <i class="material-icons">remove_shopping_cart</i>
          </div>
          <h3>Carrito VacÃ­o</h3>
          <p>Agrega productos para comenzar una venta</p>
          <button (click)="mostrarTodosProductos()" class="btn-explore-products">
            <i class="material-icons">storefront</i>
            Explorar Productos
          </button>
        </div>

        <div *ngIf="venta.detalles.length > 0" class="cart-items-container">
          <div class="cart-items">
            <div *ngFor="let detalle of venta.detalles; let i = index" class="cart-item fade-in">
              <div class="cart-item-content">
                <div class="cart-item-info">
                  <div class="cart-item-header">
                    <!-- Aplicar truncate aquÃ­ -->
                  <h4>{{ detalle.producto_nombre | truncate:20 }}</h4>
                    <span class="cart-item-price">S/ {{ detalle.precio_unitario | number:'1.2-2' }}</span>
                  </div>
                  <div class="cart-item-meta">
                    <span class="meta-item">
                      <i class="material-icons">numbers</i>
                      Cantidad: {{ detalle.cantidad }}
                    </span>
                    <span class="meta-item">
                      <i class="material-icons">calculate</i>
                      Subtotal: S/ {{ (detalle.cantidad * detalle.precio_unitario) | number:'1.2-2' }}
                    </span>
                  </div>
                </div>
                <div class="cart-item-actions">
                  <button (click)="removerProducto(i)" class="btn-remove" title="Eliminar">
                    <i class="material-icons">delete</i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="cart-summary">
            <div class="summary-row">
              <span>Subtotal:</span>
              <span>S/ {{ venta.total | number:'1.2-2' }}</span>
            </div>
            <div class="summary-row total-row">
              <span>Total a Pagar:</span>
              <span class="total-amount">S/ {{ venta.total | number:'1.2-2' }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- MÃ©todos de Pago -  Debajo de Cliente -->
      <div class="section pago-section neumorphic-card">
        <h2>
          <i class="material-icons">payments</i>
          MÃ©todo de Pago
        </h2>
        
        <div class="payment-methods">
          <div class="form-group">
            <label>Seleccione mÃ©todo de pago:</label>
            <select [(ngModel)]="venta.id_metodo_pago" class="form-select elegant-input">
              <option *ngFor="let metodo of metodosPago" [value]="metodo.id_metodo_pago">
                {{ metodo.metodo_pago }}
              </option>
            </select>
          </div>
          
          <!-- Agregar Ã­conos a los mÃ©todos de pago -->
          <div class="payment-icons">
            <div class="payment-icon" 
                 [class.active]="venta.id_metodo_pago === 1"
                 (click)="venta.id_metodo_pago = 1">
              <i class="material-icons">payments</i>
              <span>Efectivo</span>
            </div>
            <div class="payment-icon" 
                 [class.active]="venta.id_metodo_pago === 2"
                 (click)="venta.id_metodo_pago = 2">
              <i class="material-icons">qr_code_scanner</i>
              <span>Yape</span>
            </div>
            <div class="payment-icon" 
                 [class.active]="venta.id_metodo_pago === 3"
                 (click)="venta.id_metodo_pago = 3">
              <i class="material-icons">account_balance</i>
              <span>Transferencia</span>
            </div>
            <div class="payment-icon" 
                 [class.active]="venta.id_metodo_pago === 4"
                 (click)="venta.id_metodo_pago = 4">
              <i class="material-icons">credit_card</i>
              <span>Tarjeta</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- COLUMNA 3: Comprobante -->
    <div class="columna-derecha">
      <!-- Comprobante -->
      <div class="section comprobante-section neumorphic-card">
        <h2>
          <i class="material-icons">receipt_long</i>
          Comprobante
        </h2>
        
        <div class="comprobante-types">
                <!-- En la secciÃ³n de Comprobante, modifica la opciÃ³n de Nota de Venta -->
        <div class="comprobante-option" 
            [class.selected]="venta.tipo_comprobante === 'SIN_COMPROBANTE'"
            (click)="seleccionarNotaDeVenta()"> <!-- Cambia esto -->
          <i class="material-icons">note</i>
          <div class="option-content">
            <h4>Nota de Venta</h4>
            <p>Sin comprobante oficial</p>
          </div>
          <i class="material-icons check-icon" *ngIf="venta.tipo_comprobante === 'SIN_COMPROBANTE'">check_circle</i>
        </div>
          
          <!-- Las otras opciones quedarÃ­an asÃ­: -->
<div class="comprobante-option" 
     [class.selected]="venta.tipo_comprobante === 'BOLETA'"
     (click)="seleccionarComprobante('BOLETA')"> <!-- Nuevo mÃ©todo -->
  <i class="material-icons">receipt</i>
  <div class="option-content">
    <h4>Boleta ElectrÃ³nica</h4>
    <p>Para clientes con DNI</p>
  </div>
  <i class="material-icons check-icon" *ngIf="venta.tipo_comprobante === 'BOLETA'">check_circle</i>
</div>
          
          <div class="comprobante-option" 
     [class.selected]="venta.tipo_comprobante === 'FACTURA'"
     (click)="seleccionarComprobante('FACTURA')"> <!-- Nuevo mÃ©todo -->
  <i class="material-icons">description</i>
  <div class="option-content">
    <h4>Factura ElectrÃ³nica</h4>
    <p>Para clientes con RUC</p>
  </div>
  <i class="material-icons check-icon" *ngIf="venta.tipo_comprobante === 'FACTURA'">check_circle</i>
</div>
        </div>
        
        <!-- Preview de comprobante -->
        <div *ngIf="serieNumeroPreview" class="comprobante-preview slide-up">
          <div class="preview-header">
            <i class="material-icons">preview</i>
            <h4>Vista Previa</h4>
          </div>
          <div class="preview-content">
            <div class="preview-row">
              <span>Serie/NÃºmero:</span>
              <strong>{{ serieNumeroPreview }}</strong>
            </div>
            <div class="preview-row">
              <span>Cliente:</span>
              <span>{{ clienteSeleccionadoNombre }}</span>
            </div>
            <div class="preview-row">
              <span>Fecha:</span>
              <span>{{ venta.fecha | date:'dd/MM/yyyy' }}</span>
            </div>
          </div>
        </div>
        
        <div *ngIf="loadingSerie" class="loading-comprobante">
          <div class="spinner"></div>
          <span>Generando nÃºmero de comprobante...</span>
        </div>
      </div>
    </div>

 <!-- FILA INFERIOR: Acciones - VERSIÃ“N MEJORADA -->
<div class="seccion-acciones">
  <div class="acciones-contenedor">
    <!-- Primera fila: Botones principales -->
    <div class="acciones-fila-superior">
      <button 
        (click)="finalizarVenta()" 
        [disabled]="loading || venta.detalles.length === 0 || venta.id_cliente === 0"
        class="btn-accion btn-finalizar btn-with-icon">
        <i class="material-icons" *ngIf="!loading">check_circle</i>
        <div class="spinner" *ngIf="loading"></div>
        {{ loading ? 'Procesando...' : 'Finalizar Venta' }}
      </button>
      
      <button (click)="limpiarVenta()" class="btn-accion btn-limpiar btn-with-icon">
        <i class="material-icons">refresh</i>
        Limpiar Todo
      </button>
      
      <button (click)="router.navigate(['/ventas'])" class="btn-accion btn-volver btn-with-icon">
        <i class="material-icons">arrow_back</i>
        Ir al Panel de Ventas
      </button>
    </div>
    
    <!-- Segunda fila: Estado y comprobante -->
    <div class="acciones-fila-inferior">
      <!-- Estado de la venta -->
      <div class="estado-venta">
        <div class="estado-item" *ngIf="venta.id_cliente === 0">
          <i class="material-icons icono-estado icono-advertencia">warning</i>
          <span>Seleccione un cliente</span>
        </div>
        <div class="estado-item" *ngIf="venta.detalles.length === 0">
          <i class="material-icons icono-estado icono-advertencia">warning</i>
          <span>Agregue productos al carrito</span>
        </div>
        <div class="estado-item" *ngIf="venta.id_cliente !== 0 && venta.detalles.length > 0">
          <i class="material-icons icono-estado icono-exito">check_circle</i>
          <span>Listo para procesar</span>
        </div>
      </div>
    </div>
  </div>
</div>

    <!-- Mensajes de error -->
    <div *ngIf="error" class="error-message slide-up full-width">
      <i class="material-icons">error_outline</i>
      <div class="error-content">
        <h4>Error</h4>
        <p>{{ error }}</p>
      </div>
      <button (click)="error = ''" class="btn-close-error">
        <i class="material-icons">close</i>
      </button>
    </div>
  </div>
  
  <!-- Footer informativo -->
  <div class="footer-info">
    <span>Â© {{ currentYear }} Sistema Agua ViÃ±a</span>
    <span class="separator">|</span>
    <span>Vendedor: {{ getVendedorNombre() }}</span>
    <span class="separator">|</span>
    <span>Ãšltima actualizaciÃ³n: {{ lastUpdate | date:'HH:mm:ss' }}</span>
  </div>
</div>